version: "3.8"

# =============================================================================
# candata — local development compose file
#
# Services:
#   supabase-db      Postgres with pgvector + PostGIS
#   supabase-studio  Supabase Studio UI
#   supabase-kong    API gateway (PostgREST, Auth, Storage, Realtime)
#   supabase-auth    GoTrue authentication service
#   supabase-rest    PostgREST auto-API
#   supabase-storage Object storage
#   supabase-meta    Postgres meta API (used by Studio)
#   api              FastAPI backend (packages/api)
#
# For a full local Supabase stack it is strongly recommended to use the
# Supabase CLI instead:  supabase start
# This compose file provides a minimal self-contained alternative.
# =============================================================================

x-supabase-env: &supabase-env
  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
  JWT_SECRET: ${JWT_SECRET:-super-secret-jwt-token-with-at-least-32-characters-long}
  ANON_KEY: ${SUPABASE_ANON_KEY:-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRFA0NiK7ACcPanFkUZRkztAo0JFMKoiditlzJFeCBY}
  SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_KEY:-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hj04zWl196z2-SBc0}

services:
  # ---------------------------------------------------------------------------
  # Supabase PostgreSQL
  # ---------------------------------------------------------------------------
  supabase-db:
    image: supabase/postgres:15.6.1.143
    restart: unless-stopped
    ports:
      - "54322:5432"
    environment:
      <<: *supabase-env
      POSTGRES_DB: postgres
    volumes:
      - supabase-db-data:/var/lib/postgresql/data
      - ./supabase/migrations:/docker-entrypoint-initdb.d/migrations:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------------------------------------------------------------------------
  # Supabase Auth (GoTrue)
  # ---------------------------------------------------------------------------
  supabase-auth:
    image: supabase/gotrue:v2.143.0
    restart: unless-stopped
    depends_on:
      supabase-db:
        condition: service_healthy
    environment:
      <<: *supabase-env
      GOTRUE_API_HOST: "0.0.0.0"
      GOTRUE_API_PORT: "9999"
      API_EXTERNAL_URL: "http://localhost:54321"
      GOTRUE_DB_DRIVER: postgres
      GOTRUE_DB_DATABASE_URL: "postgres://supabase_auth_admin:${POSTGRES_PASSWORD:-postgres}@supabase-db:5432/postgres?search_path=auth"
      GOTRUE_SITE_URL: "http://localhost:3000"
      GOTRUE_URI_ALLOW_LIST: ""
      GOTRUE_DISABLE_SIGNUP: "false"
      GOTRUE_JWT_ADMIN_ROLES: service_role
      GOTRUE_JWT_AUD: authenticated
      GOTRUE_JWT_DEFAULT_GROUP_NAME: authenticated
      GOTRUE_JWT_EXP: "3600"
      GOTRUE_JWT_SECRET: ${JWT_SECRET:-super-secret-jwt-token-with-at-least-32-characters-long}
      GOTRUE_MAILER_AUTOCONFIRM: "true"
      GOTRUE_SMTP_ADMIN_EMAIL: admin@candata.local
      GOTRUE_SMTP_HOST: ""
      GOTRUE_SMTP_PORT: "587"

  # ---------------------------------------------------------------------------
  # PostgREST
  # ---------------------------------------------------------------------------
  supabase-rest:
    image: postgrest/postgrest:v12.2.0
    restart: unless-stopped
    depends_on:
      supabase-db:
        condition: service_healthy
    environment:
      PGRST_DB_URI: "postgres://authenticator:${POSTGRES_PASSWORD:-postgres}@supabase-db:5432/postgres"
      PGRST_DB_SCHEMAS: public,storage,graphql_public
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: ${JWT_SECRET:-super-secret-jwt-token-with-at-least-32-characters-long}
      PGRST_DB_USE_LEGACY_GUCS: "false"
      PGRST_APP_SETTINGS_JWT_SECRET: ${JWT_SECRET:-super-secret-jwt-token-with-at-least-32-characters-long}
      PGRST_APP_SETTINGS_JWT_EXP: "3600"

  # ---------------------------------------------------------------------------
  # Supabase Kong (API gateway)
  # ---------------------------------------------------------------------------
  supabase-kong:
    image: kong:2.8.1
    restart: unless-stopped
    depends_on:
      supabase-db:
        condition: service_healthy
    ports:
      - "54321:8000"
      - "54320:8443"
    environment:
      <<: *supabase-env
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /var/lib/kong/kong.yml
      KONG_DNS_ORDER: LAST,A,CNAME
      KONG_PLUGINS: request-transformer,cors,key-auth,acl,basic-auth
      KONG_NGINX_PROXY_PROXY_BUFFER_SIZE: 160k
      KONG_NGINX_PROXY_PROXY_BUFFERS: "64 160k"
    volumes:
      - ./supabase/kong.yml:/var/lib/kong/kong.yml:ro

  # ---------------------------------------------------------------------------
  # Supabase Studio
  # ---------------------------------------------------------------------------
  supabase-studio:
    image: supabase/studio:2024.01.22-sha-4c89d40
    restart: unless-stopped
    depends_on:
      supabase-db:
        condition: service_healthy
    ports:
      - "54323:3000"
    environment:
      <<: *supabase-env
      STUDIO_PG_META_URL: http://supabase-meta:8080
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      DEFAULT_ORGANIZATION_NAME: candata
      DEFAULT_PROJECT_NAME: candata-local
      SUPABASE_URL: http://supabase-kong:8000
      SUPABASE_PUBLIC_URL: http://localhost:54321
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_KEY}
      LOGFLARE_API_KEY: ""
      LOGFLARE_URL: http://analytics:4000
      NEXT_PUBLIC_ENABLE_LOGS: "true"

  # ---------------------------------------------------------------------------
  # Postgres Meta (used by Studio)
  # ---------------------------------------------------------------------------
  supabase-meta:
    image: supabase/postgres-meta:v0.80.0
    restart: unless-stopped
    depends_on:
      supabase-db:
        condition: service_healthy
    environment:
      PG_META_PORT: "8080"
      PG_META_DB_HOST: supabase-db
      PG_META_DB_PORT: "5432"
      PG_META_DB_NAME: postgres
      PG_META_DB_USER: supabase
      PG_META_DB_PASSWORD: ${POSTGRES_PASSWORD:-postgres}

  # ---------------------------------------------------------------------------
  # candata API (packages/api)
  # Build context uses packages/api — only started when API package exists.
  # Comment out if running the API outside Docker.
  # ---------------------------------------------------------------------------
  # api:
  #   build:
  #     context: packages/api
  #     dockerfile: Dockerfile
  #   restart: unless-stopped
  #   depends_on:
  #     supabase-db:
  #       condition: service_healthy
  #   ports:
  #     - "${API_PORT:-8000}:8000"
  #   env_file:
  #     - .env
  #   volumes:
  #     - ./data:/app/data
  #   command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

volumes:
  supabase-db-data:
